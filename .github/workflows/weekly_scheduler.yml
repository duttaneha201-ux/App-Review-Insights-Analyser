name: Weekly Review Analysis Scheduler

on:
  schedule:
    # Monday 08:00 IST = Monday 02:30 UTC
    # IST is UTC+5:30, so 08:00 IST = 02:30 UTC
    - cron: '30 2 * * 1'
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: '3.11'

jobs:
  weekly-analysis:
    name: Weekly Review Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Fail if job runs longer than 60 minutes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libatk-bridge2.0-0 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libasound2
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      - name: Set up environment variables
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
          SMTP_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Environment variables configured"
          # Verify critical secrets are set
          if [ -z "$GROQ_API_KEY" ]; then
            echo "ERROR: GROQ_API_KEY is not set"
            exit 1
          fi
          if [ -z "$SMTP_HOST" ]; then
            echo "ERROR: SMTP_HOST is not set"
            exit 1
          fi
          if [ -z "$SMTP_USERNAME" ]; then
            echo "ERROR: SMTP_USERNAME is not set"
            exit 1
          fi
          if [ -z "$SMTP_PASSWORD" ]; then
            echo "ERROR: SMTP_PASSWORD is not set"
            exit 1
          fi
          # Warn if DATABASE_URL is not set (SQLite won't persist between runs)
          if [ -z "$DATABASE_URL" ]; then
            echo "WARNING: DATABASE_URL is not set. Using default SQLite database."
            echo "WARNING: SQLite files are ephemeral in GitHub Actions and won't persist between runs."
            echo "WARNING: Consider using a remote database (PostgreSQL) for production."
          fi
      
      - name: Run weekly scheduler
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
          SMTP_FROM_NAME: ${{ secrets.SMTP_FROM_NAME }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "::group::Weekly Analysis Job"
          python scripts/run_weekly_scheduler.py
          echo "::endgroup::"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: scheduler-logs
          path: |
            *.log
            logs/
          if-no-files-found: ignore
          retention-days: 7

